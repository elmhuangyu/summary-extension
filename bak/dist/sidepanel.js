import{d as l}from"./utils-5pEQLTu1.js";const a=document.getElementById("aiProviderPanel"),y=document.getElementById("responseArea"),g=document.getElementById("loadingIndicator"),E=document.getElementById("summarizeBtn"),k=document.getElementById("chatInput"),P=document.getElementById("sendChatBtn"),p=document.getElementById("geminiThinkingMode"),m=document.getElementById("geminiThinkingModeArea");let d="default",r="",A="en",u=null;function s(e,i){const n=document.createElement("div");n.classList.add(i),n.innerHTML=e.replace(/\n/g,"<br>"),y.appendChild(n),y.scrollTop=y.scrollHeight}document.addEventListener("DOMContentLoaded",()=>{chrome.storage.local.get(["defaultAi","language","openaiApiKey","geminiApiKey","geminiModel","openaiCompatibleProviders"],e=>{e.language&&(A=e.language);const i=e.openaiCompatibleProviders||[];d=e.defaultAi||"default",r=e.geminiModel||"gemini-2.0-flash",C(i,e.defaultAi),d=a.value,l("Sidepanel loaded settings:",{defaultAi:e.defaultAi,language:e.language,geminiModel:e.geminiModel,effectiveGeminiModel:r,initialAiProviderInPanel:d,customProvidersCount:i.length}),v();let n=d;d==="default"&&(n=e.defaultAi||"openai");const o=i.some(t=>t.name===n);if(!e.openaiApiKey&&!e.geminiApiKey&&!i.some(t=>t.accessToken))s("Welcome! Please configure your AI provider API keys or add a custom provider in the extension settings.","ai-message");else if(n==="openai"&&!e.openaiApiKey)s("OpenAI is your selected provider, but the API key is missing. Please set it in options.","error-message");else if(n==="gemini"&&!e.geminiApiKey)s("Gemini is your selected provider, but the API key is missing. Please set it in options.","error-message");else if(o){const t=i.find(c=>c.name===n);(!t||!t.accessToken||!t.baseUrl||!t.model)&&s(`The custom provider "${n}" is missing required configuration (e.g., access token). Please check settings.`,"error-message")}}),a.addEventListener("change",e=>{d=e.target.value,l("AI Provider changed in panel to:",d),s(`Switched to ${e.target.options[e.target.selectedIndex].text}.`,"ai-message"),v()}),chrome.storage.onChanged.addListener((e,i)=>{if(i==="local"){let n=!1;e.geminiModel&&(r=e.geminiModel.newValue||"gemini-2.0-flash",l("Gemini model changed via storage: ",r),n=!0),e.defaultAi&&(l("Default AI provider changed via storage: ",e.defaultAi.newValue),n=!0),e.openaiCompatibleProviders&&(l("Custom providers changed via storage."),n=!0),n&&chrome.storage.local.get(["defaultAi","geminiModel","openaiCompatibleProviders"],o=>{r=o.geminiModel||"gemini-2.0-flash";const t=o.openaiCompatibleProviders||[];C(t,o.defaultAi),d=a.value,v(),l("Sidepanel UI updated due to storage change.")})}})});function C(e,i){const n=a.value||d||i||"default";a.innerHTML="";const o=document.createElement("option");o.value="default",o.textContent=`(Default)${i?` - ${i.substring(0,20)}`:""}`,a.appendChild(o);const t=document.createElement("option");t.value="openai",t.textContent="OpenAI (Official)",a.appendChild(t);const c=document.createElement("option");c.value="gemini",c.textContent="Gemini (Official)",a.appendChild(c),e.forEach(f=>{const h=document.createElement("option");h.value=f.name,h.textContent=f.name,a.appendChild(h)}),Array.from(a.options).some(f=>f.value===n)?a.value=n:a.value="default"}function v(){let e=a.value;e==="default"?chrome.storage.local.get(["defaultAi","geminiModel"],i=>{const n=i.defaultAi||"openai";r=i.geminiModel||"gemini-2.0-flash",n==="gemini"&&r&&r.startsWith("gemini-2.5")?m.style.display="block":(m.style.display="none",p.checked=!1),l(`Gemini Thinking Mode (default flow): actualDefault=${n}, model=${r}, visible=${m.style.display==="block"}`)}):e==="gemini"?chrome.storage.local.get(["geminiModel"],i=>{r=i.geminiModel||"gemini-2.0-flash",r&&r.startsWith("gemini-2.5")?m.style.display="block":(m.style.display="none",p.checked=!1),l(`Gemini Thinking Mode (direct gemini): model=${r}, visible=${m.style.display==="block"}`)}):(m.style.display="none",p.checked=!1,l(`Gemini Thinking Mode (openai/custom): provider=${e}, visible=false`))}async function b(){var e;g.style.display="block",(e=y.querySelector(".welcome-message"))==null||e.remove();try{const i=await new Promise((o,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},c=>{c&&c.length>0?o(c[0]):t(new Error("No active tab found."))})});if(!i||!i.id)throw new Error("Cannot identify active tab.");const n=await chrome.tabs.sendMessage(i.id,{action:"getPageContent"});if(n&&n.content)return u=n.content,l("Received markdown from content script (length):",u.length),u.startsWith("Error:")?(s(`Could not fetch page content: ${u}`,"error-message"),null):u;throw new Error("No content received from content script.")}catch(i){return console.error("Error getting page content:",i),s(`Error fetching page content: ${i.message}. Ensure the page is fully loaded and try again. Some pages (e.g., chrome:// pages, store pages) are restricted.`,"error-message"),null}finally{g.style.display="none"}}E.addEventListener("click",async()=>{s("Summarizing page...","user-message");const e=u||await b();if(e){l("Summarize button clicked. Content acquired. Ready for AI call."),g.style.display="block";try{let i=!1;m.style.display==="block"&&p.checked&&(i=!0);const n=await callAIService("summarize",e,d,A,i);s(n,"ai-message")}catch(i){console.error("Summarization error:",i),s(`Error during summarization: ${i.message}`,"error-message")}finally{g.style.display="none"}}});P.addEventListener("click",async()=>{const e=k.value.trim();if(!e)return;s(e,"user-message"),k.value="";const i=u||await b();if(i||e.toLowerCase().includes("hello")||e.toLowerCase().includes("hi")){l("Chat message sent. Content acquired (if any). Ready for AI call."),g.style.display="block";try{let n=!1;m.style.display==="block"&&p.checked&&(n=!0);const o=await callAIService("chat",{question:e,context:i},d,A,n);s(o,"ai-message")}catch(n){console.error("Chat error:",n),s(`Error during chat: ${n.message}`,"error-message")}finally{g.style.display="none"}}});k.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),P.click())});l("Sidepanel event listeners and functions set up.");
